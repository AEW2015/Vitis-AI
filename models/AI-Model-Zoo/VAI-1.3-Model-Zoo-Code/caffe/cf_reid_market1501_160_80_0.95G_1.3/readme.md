### Contents

1. [Installation](#installation)
2. [Demo](#Demo)
3. [Evaluation](#Evaluation)
4. [Performance](#performance)
5. [Model_info](#model_info)

### Installation
##### 1. Install caffe_xilinx
1. Get xilinx caffe_xilinx code.
  ```shell
  unzip caffe_xilinx.zip
  cd caffe_xilinx
  ```
2. Build the code. Please follow [Caffe instruction](http://caffe.berkeleyvision.org/installation.html) to install all necessary packages and build it.
  ```shell
  # Modify Makefile.config according to your Caffe installation.
  cp Makefile.config.example Makefile.config
  make -j8
  # use python2
  make pycaffe
  ```
##### 2. Install 3rd party library 
```
pip install opencv-python
pip install numpy
```

### Demo
The demo.py provides a running sample. The test images are in **data/test_imgs**. The demo will employ the reid model to extract the feature of each image and give a feature distance matrix.
To run the demo, you need to modify **caffe_path**, **prototxt_path**, **caffemodel_path** in **demo.sh**, and run:
```
cd code/test
sh demo.sh
```


### Evaluation
We provide the evalution code on dataset [market1501](http://liangzheng.org/Project/project_reid.html). Download the dataset and put it into **data**, the data structure should look like:
  ```
data/
    market1501/
         query/
             xxx.jpg   
             xxx.jpg   
         bounding_box_train/
             xxx.jpg   
             xxx.jpg   
         bounding_box_test/
             xxx.jpg   
             xxx.jpg   
  ```
  Then, you can modify **caffe_path**, **prototxt_path**, **caffemodel_path**, **dataset_path** in **test.sh**, and run:
  ```
  cd code/test
  sh test.sh
  ```
  For quantized model, you can modify **caffe_path**, **prototxt_path**, **caffemodel_path**, **dataset_path** in **test_quantized.sh**, and run:
  ```
  cd code/test
  sh test_quantized.sh
  ```

### Performance

| Accuracy | Eval on Market1501 |
| --------- | ------------------ |
| mAP     | 56.6% |
| Rank-1  | 78.0% |
|Rank-5   | 89.9% |
|Rank-10 | 93.3% |

### Model info
##### 1. Data preprocess
  ```
1. data channel order: RGB(0~255)                  
2. resize: 160 * 80(H * W)                           
3. mean_value: 123, 116, 103
4. scale: 0.017429 
  ```
##### 2. Quantization with calibration mode(post-training)
  ```
Modify datalayer of test.prototxt for model quantization:
a. Replace the "Input" data layer of test.prototxt with the "ImageData" data layer.
b. Modify the "ImageData" layer parameters according to the data preprocess information.
c. Provide a "quant.txt" file, including image path and label information with fake value(like 1).
d. Give examples of data layer and "quant.txt":

# data layer example
  layer {
  name: "data"
  type: "ImageData"
  top: "data"
  top: "label"
  include {
    phase: TRAIN
  }
  transform_param {
    mirror: false
    mean_value: 103
    mean_value: 116
    mean_value: 123
   }

  image_data_param {
    source: "quant.txt"
    new_width: 80 
    new_height: 160
    batch_size: 16
  }
}
# quant.txt: image path label
  images/000001.jpg 1
  images/000002.jpg 1
  images/000003.jpg 1

  ```
4.For deployment, modify "deploy.prototxt" generated by quantizer
  ```
  replace first 7 lines to input layer:
layer {
  name: "data"
  type: "Input"
  top: "data"
  transform_param {
    mean_value: 103
    mean_value: 116
    mean_value: 123
  }
  input_param {
    shape {
      dim: 1
      dim: 3
      dim: 160
      dim: 80
    }
  }
}  
  ```



